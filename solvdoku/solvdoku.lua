
-- GameData <<<
local GameData =
{

   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=1,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=2,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=3,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=4,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=5,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=6,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=7,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=8,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=1,col=9,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=1,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=2,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=3,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=4,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=5,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=6,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=7,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=8,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=2,col=9,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=1,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=2,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=3,fld=1},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=4,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=5,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=6,fld=2},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=7,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=8,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=3,col=9,fld=3},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=1,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=2,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=3,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=4,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=5,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=6,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=7,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=8,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=4,col=9,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=1,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=2,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=3,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=4,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=5,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=6,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=7,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=8,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=5,col=9,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=1,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=2,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=3,fld=4},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=4,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=5,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=6,fld=5},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=7,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=8,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=6,col=9,fld=6},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=1,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=2,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=3,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=4,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=5,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=6,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=7,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=8,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=7,col=9,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=1,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=2,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=3,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=4,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=5,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=6,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=7,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=8,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=8,col=9,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=1,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=2,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=3,fld=7},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=4,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=5,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=6,fld=8},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=7,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=8,fld=9},
   {true,true,true,true,true,true,true,true,true,value_n=0,value_s='',row=9,col=9,fld=9},

} -- >>>

-- Rows <<<
local Rows=
{
   { 1 ,  2 ,  3 ,  4 ,  5 ,  6 ,  7 ,  8 ,  9} , 
   {10 , 11 , 12 , 13 , 14 , 15 , 16 , 17 , 18} , 
   {19 , 20 , 21 , 22 , 23 , 24 , 25 , 26 , 27} , 
   {28 , 29 , 30 , 31 , 32 , 33 , 34 , 35 , 36} , 
   {37 , 38 , 39 , 40 , 41 , 42 , 43 , 44 , 45} , 
   {46 , 47 , 48 , 49 , 50 , 51 , 52 , 53 , 54} , 
   {55 , 56 , 57 , 58 , 59 , 60 , 61 , 62 , 63} , 
   {64 , 65 , 66 , 67 , 68 , 69 , 70 , 71 , 72} , 
   {73 , 74 , 75 , 76 , 77 , 78 , 79 , 80 , 81} , 
} -- >>>

-- Columns <<<
local Columns=
{
   { 1 , 10 , 19 , 28 , 37 , 46 , 55 , 64 , 73} , 
   { 2 , 11 , 20 , 29 , 38 , 47 , 56 , 65 , 74} , 
   { 3 , 12 , 21 , 30 , 39 , 48 , 57 , 66 , 75} , 
   { 4 , 13 , 22 , 31 , 40 , 49 , 58 , 67 , 76} , 
   { 5 , 14 , 23 , 32 , 41 , 50 , 59 , 68 , 77} , 
   { 6 , 15 , 24 , 33 , 42 , 51 , 60 , 69 , 78} , 
   { 7 , 16 , 25 , 34 , 43 , 52 , 61 , 70 , 79} , 
   { 8 , 17 , 26 , 35 , 44 , 53 , 62 , 71 , 80} , 
   { 9 , 18 , 27 , 36 , 45 , 54 , 63 , 72 , 81} , 
} -- >>>

-- Fields <<<
local Fields=
{
   {1  , 2  , 3  , 10 , 11 , 12 , 19 , 20 , 21}, 
   {4  , 5  , 6  , 13 , 14 , 15 , 22 , 23 , 24}, 
   {7  , 8  , 9  , 16 , 17 , 18 , 25 , 26 , 27}, 
   {28 , 29 , 30 , 37 , 38 , 39 , 46 , 47 , 48}, 
   {31 , 32 , 33 , 40 , 41 , 42 , 49 , 50 , 51}, 
   {34 , 35 , 36 , 43 , 44 , 45 , 52 , 53 , 54}, 
   {55 , 56 , 57 , 64 , 65 , 66 , 73 , 74 , 75}, 
   {58 , 59 , 60 , 67 , 68 , 69 , 76 , 77 , 78}, 
   {61 , 62 , 63 , 70 , 71 , 72 , 79 , 80 , 81}, 
} -- >>>

function helpUnset(i,v) -- <<<

   if GameData[i].value_n ~= 0 then
      goto continue
   end

   for _,x in ipairs(Rows[GameData[i].row]) do
      if GameData[x].value_n == v then
         goto continue
      end
   end

   for _,x in ipairs(Columns[GameData[i].col]) do
      if GameData[x].value_n == v then
         goto continue
      end
   end

   for _,x in ipairs(Fields[GameData[i].fld]) do
      if GameData[x].value_n == v then
         goto continue
      end
   end

   GameData[i][v] = true

   ::continue::
end -- >>>

function unsetValue(i) -- <<<

   local ValueToUnset = GameData[i].value_n

   GameData[i].value_n = 0
   GameData[i].value_s = ''

   for idx,_ in ipairs(GameData) do
      helpUnset(idx,ValueToUnset)
   end

   for n=1,9 do
      helpUnset(i,n)
   end

   return ValueToUnset
end -- >>>

function helpSet(i,v) -- <<<
   -- check if value can be set
   if GameData[i][v] == false then
      return false
   end

   -- set value
   for x,_ in ipairs(GameData[i]) do
      GameData[i][x] = false
   end
   GameData[i].value_n = v
   GameData[i].value_s = tostring(v)

   -- set the correct reminder flags to false
   for _,x in ipairs(Rows[GameData[i].row]) do
      GameData[x][v] = false
   end

   for _,x in ipairs(Columns[GameData[i].col]) do
      GameData[x][v] = false
   end

   for _,x in ipairs(Fields[GameData[i].fld]) do
      GameData[x][v] = false
   end

   return true
end -- >>>

function setValue(i,v) -- <<<
   -- 1.     0, not set -> do nothting -> return false
   -- 2.     0,     set -> undo setting -> return true/false?
   -- 3. not 0, not set -> set value -> return true
   -- 4. not 0,     set -> undo setting and set value -> return true

   if v == 0 then
      if GameData[i].value_n == 0 then
         return false
      else
         unsetValue(i)
         return false
         -- return true --> would trigger a completed-check
      end
   else
      if GameData[i].value_n == 0 then
         return helpSet(i,v)
      else
         local ValueUnset = unsetValue(i)
         local SetSuccess = helpSet(i,v)
         if SetSuccess then
            return true
         else
            return helpSet(i,ValueUnset)
         end
      end
   end
end -- >>>

function isComplete() -- <<<
   for i,v in ipairs(GameData) do
      for j,w in ipairs(GameData[i]) do
         if GameData[i][j] then
            return false
         end
      end
   end
   return true
end -- >>>

function getLastPossibleValue(i) -- <<<

   local Counter = 0
   local Value

   for j,v in ipairs(GameData[i]) do
      if v then
         Counter = Counter + 1
         Value   = j
      end
   end

   if Counter == 1 then
      return Value
   else
      return nil
   end
end -- >>>

function autoFill() -- <<<

   local Return = false

   -- iterate cells
   for i,v in ipairs(GameData) do
      local Value = getLastPossibleValue(i)
      if Value then
         setValue(i, Value)
         Return = true
      end
   end

   -- iterate fields, rows and cols
   for _,t in ipairs({Fields, Rows, Columns}) do
      for n=1,9 do
         for _,x in ipairs(t) do
            local nList = {}
            for _,c in ipairs(x) do
               if GameData[c].value_n == 0 then
                  if GameData[c][n] then
                     table.insert(nList,c)
                  end
               end
            end
            if #nList == 1 then
               setValue(nList[1], n)
               Return = true
            end
         end
      end
   end

   return Return
end -- >>>

return
{
   GameData   = GameData,
   setValue   = setValue,
   isComplete = isComplete,
   autoFill   = autoFill,
}

-- vim: fmr=<<<,>>> fdm=marker
